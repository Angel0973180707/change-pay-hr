<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b3d2e" />
  <title>æ¸¯å¹£85%æ›åŒ¯ï½œæŒ‰æœˆè¨˜å¸³ç°¿</title>

  <link rel="manifest" href="./manifest.json" />
  <link rel="apple-touch-icon" href="./icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />

  <style>
    :root{
      --bg:#0b3d2e;
      --card:#ffffff;
      --text:#102018;
      --muted:#66746c;
      --line:#e6eee9;
      --soft:#f4faf7;
      --accent:#1f7a5b;
      --danger:#b42318;
      --shadow:0 10px 24px rgba(16,32,24,.10);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", Arial, sans-serif;
      background:linear-gradient(180deg, #073023 0%, #0b3d2e 40%, #083226 100%);
      color:#fff;
      min-height:100vh;
    }
    .wrap{max-width:1120px;margin:0 auto;padding:18px 14px 44px}
    .top{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      padding:10px 6px 12px;
    }
    .brand h1{margin:0;font-size:20px;letter-spacing:.5px}
    .brand p{margin:6px 0 0;color:rgba(255,255,255,.82);font-size:13px;line-height:1.45}
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:8px 10px; border:1px solid rgba(255,255,255,.18);
      border-radius:999px; font-size:12px; color:rgba(255,255,255,.92);
      background:rgba(255,255,255,.06);
      user-select:none;
      white-space:nowrap;
    }

    .tabs{display:flex; gap:10px; flex-wrap:wrap; padding:0 6px 14px}
    .tab{
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.92);
      padding:10px 12px;
      border-radius:999px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{background:rgba(255,255,255,.14);border-color:rgba(255,255,255,.32)}

    .grid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:12px;
    }
    @media (max-width:940px){ .grid{grid-template-columns:1fr} }

    .card{
      background:var(--card);
      color:var(--text);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      border:1px solid rgba(16,32,24,.06);
      overflow:hidden;
    }
    .hd{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      background:linear-gradient(180deg, #ffffff 0%, #fbfdfc 100%);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .t{font-weight:900;font-size:15px}
    .s{margin-top:6px;color:var(--muted);font-size:12px;line-height:1.45}
    .bd{padding:14px}

    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:520px){ .row{grid-template-columns:1fr} }

    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input, textarea, select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
      font-size:16px;
      outline:none;
    }
    textarea{min-height:84px;resize:vertical;font-size:14px}
    input:focus, textarea:focus, select:focus{border-color:rgba(31,122,91,.45); box-shadow:0 0 0 4px rgba(31,122,91,.12)}

    .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    button{
      border:0;
      border-radius:14px;
      padding:12px 14px;
      font-weight:900;
      cursor:pointer;
      box-shadow:0 8px 18px rgba(16,32,24,.10);
    }
    .btn-primary{background:var(--accent); color:#fff}
    .btn-ghost{background:var(--soft); color:var(--text); border:1px solid var(--line); box-shadow:none}
    .btn-danger{background:#fff; color:var(--danger); border:1px solid rgba(180,35,24,.25); box-shadow:none}

    .note{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      background:var(--soft);
      border:1px dashed rgba(31,122,91,.25);
      color:#1f3b2f;
      font-size:12px;
      line-height:1.65;
    }

    .kpi{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .k{
      padding:12px;
      border-radius:16px;
      border:1px solid var(--line);
      background:#fff;
    }
    .k .lbl{font-size:12px;color:var(--muted)}
    .k .val{margin-top:8px;font-size:20px;font-weight:900;letter-spacing:.2px}
    .k .sub{margin-top:6px;font-size:12px;color:var(--muted)}
    .divider{height:1px;background:var(--line);margin:12px 0}

    .list{margin:0;padding:0;list-style:none;max-height:520px;overflow:auto}
    .item{padding:10px 0;border-bottom:1px solid var(--line);font-size:12px}
    .item:last-child{border-bottom:0}

    .mono{font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;}
    .muted{color:var(--muted)}
    a{color:#1f7a5b}
    .footer{
      margin-top:14px;
      color:rgba(255,255,255,.88);
      font-size:12px;
      padding:0 6px;
      line-height:1.7;
    }
    .footer a{color:#d9fff2}

    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background:rgba(0,0,0,.78); color:#fff;
      padding:10px 12px; border-radius:999px;
      font-size:12px; opacity:0; pointer-events:none;
      transition:opacity .18s ease;
      z-index:50;
    }
    .toast.show{opacity:1}

    .toolbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
    }
    .toolbar .left, .toolbar .right{display:flex; align-items:center; gap:10px; flex-wrap:wrap;}
    .smallbtn{
      padding:10px 12px;
      border-radius:12px;
      font-weight:900;
      border:1px solid var(--line);
      background:var(--soft);
      box-shadow:none;
      cursor:pointer;
    }
    .tag{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px; border-radius:999px;
      border:1px solid var(--line);
      background:var(--soft);
      font-size:11px; font-weight:900;
      color:#0b3d2e;
      white-space:nowrap;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <h1>æ¸¯å¹£ 85% å…¨æ› RMBï½œæŒ‰æœˆè¨˜å¸³</h1>
        <p>
          è¦å‰‡ï¼šæ¸¯å¹£åŠ ç¸½Ã—85% æ‰æ‹¿å»æ›åŒ¯ â†’ æ›åˆ°çš„ RMB <b>å…¨éƒ¨çµ¦å°æ–¹</b>ï¼›æ¸¯å¹£ 15% ç›´æ¥æ‰£é™¤ï¼ˆä¸é€²æ›åŒ¯ï¼‰ã€‚
        </p>
      </div>
      <div class="pill" id="netStatus">ç‹€æ…‹ï¼šâ€”</div>
    </div>

    <div class="tabs">
      <div class="tab" data-tab="fx">æ›åŒ¯ï¼ˆ85%â†’RMBï¼‰</div>
      <div class="tab" data-tab="ledger">è¨˜å¸³ç°¿ï¼ˆæŒ‰æœˆï¼‰</div>
    </div>

    <div class="grid">
      <section class="card" id="panelLeft"></section>
      <section class="card" id="panelRight"></section>
    </div>

    <div class="footer">
      <div>âœ… åŒ¯ç‡æŸ¥è©¢ï¼ˆä½ æŒ‡å®šçš„é€£çµï¼‰</div>
      <div>HKDâ†’CNYï¼š<a href="https://gu.sina.cn/quotes/fx/HKDCNY" target="_blank" rel="noreferrer">https://gu.sina.cn/quotes/fx/HKDCNY</a></div>
      <div>CNYâ†’TWDï¼š<a href="https://gu.sina.cn/quotes/fx/CNYTWD" target="_blank" rel="noreferrer">https://gu.sina.cn/quotes/fx/CNYTWD</a></div>
      <div class="muted">æé†’ï¼šæ­¤å·¥å…·ä¸è‡ªå‹•æŠ“åŒ¯ç‡ï¼ˆè·¨åŸŸé™åˆ¶ï¼‰ï¼Œä½ é»é–‹çœ‹å®Œå†å›ä¾†æ‰‹å‹•è¼¸å…¥å³å¯ã€‚</div>
    </div>
  </div>

  <div class="toast" id="toast">å®Œæˆ</div>

<script>
/* ===========================
   PWA register
=========================== */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', async () => {
    try { await navigator.serviceWorker.register('./sw.js', { scope: './' }); } catch (e) {}
  });
}

/* ===========================
   Helpers
=========================== */
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => Array.from(document.querySelectorAll(sel));

function toast(msg='å®Œæˆ'){
  const el = $('#toast');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(()=>el.classList.remove('show'), 1200);
}
async function copyText(text){
  try{
    await navigator.clipboard.writeText(text);
    toast('å·²è¤‡è£½');
  }catch{
    const ta = document.createElement('textarea');
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    ta.remove();
    toast('å·²è¤‡è£½');
  }
}
function toNum(v){
  if (v === null || v === undefined) return NaN;
  const s = String(v).replace(/,/g,'').trim();
  return s === '' ? NaN : Number(s);
}
function fmt(n, digits=2){
  if (!Number.isFinite(n)) return 'â€”';
  return n.toLocaleString('zh-Hant', { minimumFractionDigits: digits, maximumFractionDigits: digits });
}
function pad2(x){ return String(x).padStart(2,'0'); }
function yyyymm(d=new Date()){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}`; }
function nowISO(){ return new Date().toISOString(); }
function nowStr(){
  const d=new Date();
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}
function fmtTime(iso){
  if (!iso) return '';
  try{
    const d = new Date(iso);
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
  }catch{ return iso; }
}
function escapeHtml(s){
  return String(s)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#39;");
}
function uid(){
  return Math.random().toString(16).slice(2) + Date.now().toString(16);
}
function shiftMonth(ym, delta){
  const [y,m] = ym.split('-').map(Number);
  const d = new Date(y, (m-1)+delta, 1);
  return yyyymm(d);
}
function downloadText(filename, text){
  const blob = new Blob([text], { type: 'application/json;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* ===========================
   Links (user-provided)
=========================== */
const RATE_HKDCNY = 'https://gu.sina.cn/quotes/fx/HKDCNY';
const RATE_CNYTWD = 'https://gu.sina.cn/quotes/fx/CNYTWD';

/* ===========================
   Storage
=========================== */
const LS_PREF   = 'fx85_pref_v3';
const LS_LEDGER = 'fx85_ledger_v3';

function loadPref(){
  try{ const o = JSON.parse(localStorage.getItem(LS_PREF)||'{}'); return o && typeof o==='object' ? o : {}; }
  catch{ return {}; }
}
function savePref(o){ localStorage.setItem(LS_PREF, JSON.stringify(o||{})); }

function loadLedger(){
  try{
    const arr = JSON.parse(localStorage.getItem(LS_LEDGER) || '[]');
    return Array.isArray(arr) ? arr : [];
  }catch{ return []; }
}
function saveLedger(arr){
  localStorage.setItem(LS_LEDGER, JSON.stringify(arr||[]));
}

/* ===========================
   Month summary
=========================== */
function monthSummary(all, month){
  const items = all.filter(x => x.month === month);
  let fxCount=0;
  let sumFxRmb=0;      // â‘¤
  let sumIncomeHKD=0;  // â‘¥
  let sumFxHKDTotal=0;
  let sumManualIncomeHKD=0;
  let sumRmbToTwdRmb=0;
  let sumRmbToTwdTwd=0;

  for (const it of items){
    if (it.type === 'exchange85'){
      fxCount++;
      sumFxRmb += Number(it.rmbGiven)||0;
      sumFxHKDTotal += Number(it.hkdTotal)||0;
    }
    if (it.type === 'income' && it.currency === 'HKD'){
      sumManualIncomeHKD += Number(it.amount)||0;
    }
    if (it.type === 'rmb_to_twd'){
      sumRmbToTwdRmb += Number(it.rmb)||0;
      sumRmbToTwdTwd += Number(it.twd)||0;
    }
  }
  sumIncomeHKD = sumFxHKDTotal + sumManualIncomeHKD;

  return {
    count: items.length,
    fxCount,
    sumFxRmb,
    sumIncomeHKD,
    sumFxHKDTotal,
    sumManualIncomeHKD,
    sumRmbToTwdRmb,
    sumRmbToTwdTwd
  };
}

/* ===========================
   Backup (Export / Import JSON)
=========================== */
function buildBackupPayload(){
  const ledger = loadLedger();
  const payload = {
    app: "fx85",
    version: "3.1",
    exportedAt: nowISO(),
    ledger
  };
  return payload;
}
function exportBackup(){
  const payload = buildBackupPayload();
  const file = `fx85-ledger-backup_${currentMonth}.json`;
  downloadText(file, JSON.stringify(payload, null, 2));
  toast('å·²åŒ¯å‡ºå‚™ä»½');
}
function normalizeImportedPayload(obj){
  // Accept either: {ledger:[...]} or directly array
  if (Array.isArray(obj)) return { ledger: obj };
  if (obj && typeof obj === 'object' && Array.isArray(obj.ledger)) return obj;
  return null;
}
function mergeLedger(existing, incoming){
  const map = new Map(existing.map(x=>[x.id, x]));
  for (const it of incoming){
    if (it && it.id){
      if (!map.has(it.id)) map.set(it.id, it);
    }
  }
  const merged = Array.from(map.values());
  merged.sort((a,b)=>(a.ts||'').localeCompare(b.ts||''));
  return merged;
}
async function importBackupFromFile(file){
  const text = await file.text();
  let obj;
  try{ obj = JSON.parse(text); }catch{ return { ok:false, msg:'æª”æ¡ˆä¸æ˜¯æœ‰æ•ˆJSON' }; }

  const norm = normalizeImportedPayload(obj);
  if (!norm) return { ok:false, msg:'æ ¼å¼ä¸ç¬¦åˆï¼ˆæ‰¾ä¸åˆ° ledgerï¼‰' };

  const incoming = norm.ledger.filter(x => x && typeof x === 'object');
  if (!incoming.length) return { ok:false, msg:'å‚™ä»½æª”æ²’æœ‰å¯åŒ¯å…¥è³‡æ–™' };

  // Ensure essential fields for safety
  for (const it of incoming){
    if (!it.id) it.id = uid();
    if (!it.ts) it.ts = nowISO();
    if (!it.month) it.month = yyyymm(new Date(it.ts));
  }

  const existing = loadLedger();
  const merged = mergeLedger(existing, incoming);
  const added = merged.length - existing.length;
  saveLedger(merged);
  return { ok:true, msg:`å·²åŒ¯å…¥å®Œæˆï¼Œæ–°å¢ ${added} ç­†ï¼ˆåŒIDä¸é‡è¤‡ï¼‰` };
}

/* ===========================
   App state
=========================== */
const pref = loadPref();
let tab = pref.tab || 'fx';
let currentMonth = pref.month || yyyymm(new Date());

const panelLeft = $('#panelLeft');
const panelRight = $('#panelRight');

function setActiveTab(){
  $$('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
}

/* ===========================
   Network pill
=========================== */
function updateNetPill(){
  const el = $('#netStatus');
  el.textContent = navigator.onLine ? 'ç›®å‰ç‹€æ…‹ï¼šåœ¨ç·š' : 'ç›®å‰ç‹€æ…‹ï¼šé›¢ç·šï¼ˆä»å¯ç”¨ï¼‰';
}
window.addEventListener('online', updateNetPill);
window.addEventListener('offline', updateNetPill);

/* ===========================
   Render
=========================== */
function render(){
  setActiveTab();
  pref.tab = tab; pref.month = currentMonth;
  savePref(pref);

  if (tab === 'fx') renderFx();
  if (tab === 'ledger') renderLedger();
  updateNetPill();
}

$$('.tab').forEach(t=>{
  t.addEventListener('click', ()=>{
    tab = t.dataset.tab;
    render();
  });
});

/* ===========================
   FX page (85% HKD -> RMB)
=========================== */
let lastFx = null;
let lastFxCopyText = '';

function fxCalcPreview(){
  const hkdTotal = toNum($('#fx_hkd_total').value);
  const rate = toNum($('#fx_rate').value);

  if (!Number.isFinite(hkdTotal) || hkdTotal <= 0 || !Number.isFinite(rate) || rate <= 0){
    lastFx = null;
    lastFxCopyText = '';
    $('#fx_res').textContent = 'è«‹è¼¸å…¥ï¼šæ¸¯å¹£åŠ ç¸½é‡‘é¡ï¼‹åŒ¯ç‡';
    $('#fx_k1').textContent = 'â€”';
    $('#fx_k2').textContent = 'â€”';
    $('#fx_k3').textContent = 'â€”';
    $('#fx_k4').textContent = 'â€”';
    return null;
  }

  const hkd85 = hkdTotal * 0.85;
  const rmbGiven = hkd85 * rate;

  lastFx = { hkdTotal, hkd85, rate, rmbGiven };
  lastFxCopyText =
`æ¸¯å¹£åŠ ç¸½ï¼šHKD ${fmt(hkdTotal)}
æ›åŒ¯æ¸¯å¹£ï¼ˆ85%ï¼‰ï¼šHKD ${fmt(hkd85)}
åŒ¯ç‡ï¼š1 HKD = ${fmt(rate,4)} RMB
å…Œæ›äººæ°‘å¹£ï¼šRMB ${fmt(rmbGiven)}`;

  $('#fx_res').textContent = lastFxCopyText;

  $('#fx_k1').textContent = fmt(hkdTotal);
  $('#fx_k2').textContent = fmt(hkd85);
  $('#fx_k3').textContent = fmt(rate,4);
  $('#fx_k4').textContent = fmt(rmbGiven);

  return lastFx;
}

function renderFx(){
  panelLeft.innerHTML = `
    <div class="hd">
      <div>
        <div class="t">æ›åŒ¯ï¼ˆæ¸¯å¹£åŠ ç¸½ â†’ 85% å…¨æ› RMB çµ¦å°æ–¹ï¼‰</div>
        <div class="s">è¦å‰‡ï¼šåªç”¨ã€Œæ¸¯å¹£åŠ ç¸½çš„ 85%ã€å»æ›åŒ¯ï¼›æ›åˆ°çš„ RMB <b>å…¨éƒ¨çµ¦å°æ–¹</b>ï¼›æ¸¯å¹£ 15% ç›´æ¥æ‰£é™¤ã€‚</div>
      </div>
      <div class="tag">æœˆä»½ï¼š<span class="mono">${currentMonth}</span></div>
    </div>
    <div class="bd">
      <div class="row">
        <div>
          <label for="fx_hkd_total">1) æ¸¯å¹£åŠ ç¸½é‡‘é¡ï¼ˆHKDï¼‰</label>
          <input id="fx_hkd_total" inputmode="decimal" placeholder="ä¾‹å¦‚ï¼š10000" />
        </div>
        <div>
          <label for="fx_rate">3) åŒ¯ç‡ï¼ˆ1 HKD = ? RMBï¼‰</label>
          <input id="fx_rate" inputmode="decimal" placeholder="ä¾‹å¦‚ï¼š0.92" />
        </div>
      </div>

      <div style="margin-top:10px">
        <label for="fx_note">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
        <input id="fx_note" placeholder="ä¾‹å¦‚ï¼šæŸå®¢æˆ¶ / é€™æ¬¡çµå¸³" />
      </div>

      <div class="actions">
        <button class="btn-primary" id="fx_btn_calc">è¨ˆç®—</button>
        <button class="btn-ghost" id="fx_btn_copy">ä¸€éµè¤‡è£½</button>
        <button class="btn-ghost" id="fx_btn_save">å­˜å…¥è¨˜å¸³ç°¿</button>
        <button class="btn-ghost" id="fx_btn_rate">æŸ¥åŒ¯ç‡</button>
        <button class="btn-danger" id="fx_btn_clear">æ¸…ç©º</button>
      </div>

      <div class="note">
        ä¸€éµè¤‡è£½æœƒè¼¸å‡ºä½ æŒ‡å®š 4 è¡Œï¼š<br>
        1) æ¸¯å¹£åŠ ç¸½  2) 85%æ¸¯å¹£  3) åŒ¯ç‡  4) å…Œæ›RMBï¼ˆçµ¦å°æ–¹ï¼‰
      </div>

      <div class="divider"></div>

      <div class="kpi">
        <div class="k">
          <div class="lbl">1) æ¸¯å¹£åŠ ç¸½ï¼ˆHKDï¼‰</div>
          <div class="val mono" id="fx_k1">â€”</div>
          <div class="sub">100%</div>
        </div>
        <div class="k">
          <div class="lbl">2) 85% æ¸¯å¹£ï¼ˆHKDï¼‰</div>
          <div class="val mono" id="fx_k2">â€”</div>
          <div class="sub">æ‹¿å»æ›åŒ¯</div>
        </div>
        <div class="k">
          <div class="lbl">3) åŒ¯ç‡ï¼ˆHKDâ†’RMBï¼‰</div>
          <div class="val mono" id="fx_k3">â€”</div>
          <div class="sub">1 HKD = ? RMB</div>
        </div>
        <div class="k">
          <div class="lbl">4) å…Œæ›RMBï¼ˆçµ¦å°æ–¹ï¼‰</div>
          <div class="val mono" id="fx_k4">â€”</div>
          <div class="sub">å…¨éƒ¨çµ¦å°æ–¹</div>
        </div>
      </div>

      <div class="divider"></div>

      <div style="font-weight:900;margin-bottom:6px">ä¸€éµè¤‡è£½å…§å®¹é è¦½</div>
      <div class="note mono" id="fx_res">è«‹è¼¸å…¥ï¼šæ¸¯å¹£åŠ ç¸½é‡‘é¡ï¼‹åŒ¯ç‡</div>
    </div>
  `;

  panelRight.innerHTML = `
    <div class="hd">
      <div>
        <div class="t">æœ¬æœˆçµ±è¨ˆï¼ˆæŒ‰æœˆæª¢ç´¢ï¼‰</div>
        <div class="s">â‘¤ æ¯æœˆç¸½æ›åŒ¯ RMBï¼ˆçµ¦å°æ–¹ï¼‰ï¼‹â‘¥ æ¯æœˆç¸½æ”¶å…¥æ¸¯å¹£ï¼ˆå«æ›åŒ¯æ”¶æ¬¾HKDï¼‹æ‰‹å‹•æ”¶å…¥HKDï¼‰ã€‚</div>
      </div>
      <div class="tag">æœ¬æœˆï¼š<span class="mono">${currentMonth}</span></div>
    </div>
    <div class="bd">
      <div class="toolbar">
        <div class="left">
          <button class="smallbtn" id="m_prev">â—€ ä¸Šæœˆ</button>
          <button class="smallbtn" id="m_next">ä¸‹æœˆ â–¶</button>
        </div>
        <div class="right">
          <button class="smallbtn" id="goto_ledger">å»è¨˜å¸³ç°¿</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="kpi" id="fx_month_kpi"></div>

      <div class="divider"></div>
      <div style="font-weight:900;margin-bottom:6px">æœ¬æœˆæœ€è¿‘ 10 ç­†ï¼ˆæ›åŒ¯ï¼‰</div>
      <ul class="list" id="fx_month_list"></ul>
    </div>
  `;

  function renderMonth(){
    const all = loadLedger();
    const sum = monthSummary(all, currentMonth);

    $('#fx_month_kpi').innerHTML = `
      <div class="k">
        <div class="lbl">â‘¤ æ¯æœˆç¸½æ›åŒ¯ï¼ˆRMB çµ¦å°æ–¹ï¼‰</div>
        <div class="val mono">${fmt(sum.sumFxRmb)}</div>
        <div class="sub">æœ¬æœˆæ›åŒ¯ç­†æ•¸ï¼š${sum.fxCount}</div>
      </div>
      <div class="k">
        <div class="lbl">â‘¥ æ¯æœˆç¸½æ”¶å…¥æ¸¯å¹£ï¼ˆHKDï¼‰</div>
        <div class="val mono">${fmt(sum.sumIncomeHKD)}</div>
        <div class="sub">å«ï¼šæ›åŒ¯æ”¶æ¬¾HKD + æ‰‹å‹•æ”¶å…¥HKD</div>
      </div>
      <div class="k">
        <div class="lbl">æ›åŒ¯æ”¶æ¬¾HKDï¼ˆæœ¬æœˆï¼‰</div>
        <div class="val mono">${fmt(sum.sumFxHKDTotal)}</div>
        <div class="sub">çµå¸³æ™‚çš„æ¸¯å¹£åŠ ç¸½</div>
      </div>
      <div class="k">
        <div class="lbl">æ‰‹å‹•æ”¶å…¥HKDï¼ˆæœ¬æœˆï¼‰</div>
        <div class="val mono">${fmt(sum.sumManualIncomeHKD)}</div>
        <div class="sub">ä¾†è‡ªè¨˜å¸³ç°¿ã€Œæ”¶å…¥ HKDã€</div>
      </div>
    `;

    const listEl = $('#fx_month_list');
    const items = all
      .filter(x => x.month === currentMonth && x.type === 'exchange85')
      .slice()
      .sort((a,b)=>(b.ts||'').localeCompare(a.ts||''))
      .slice(0,10);

    if (!items.length){
      listEl.innerHTML = `<li class="item muted">æœ¬æœˆå°šç„¡æ›åŒ¯ç´€éŒ„</li>`;
      return;
    }

    listEl.innerHTML = '';
    for (const it of items){
      const li = document.createElement('li');
      li.className = 'item';
      li.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start">
          <div>
            <div class="mono"><b>HKD</b> ${fmt(it.hkdTotal)} â†’ 85% <b>HKD</b> ${fmt(it.hkd85)} Ã— rate ${fmt(it.rate,4)} = <b>RMB</b> ${fmt(it.rmbGiven)}</div>
            ${it.note ? `<div class="muted" style="margin-top:4px">å‚™è¨»ï¼š${escapeHtml(it.note)}</div>` : ``}
            <div class="muted" style="margin-top:4px">${fmtTime(it.ts)} ãƒ» <a href="${it.rateUrl||RATE_HKDCNY}" target="_blank" rel="noreferrer">ğŸ”— åŒ¯ç‡é€£çµ</a></div>
          </div>
          <div style="white-space:nowrap">
            <button class="smallbtn" data-del="${it.id}">åˆªé™¤</button>
          </div>
        </div>
      `;
      listEl.appendChild(li);
    }

    listEl.querySelectorAll('[data-del]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.getAttribute('data-del');
        const kept = loadLedger().filter(x=>x.id!==id);
        saveLedger(kept);
        toast('å·²åˆªé™¤');
        renderFx();
      });
    });
  }

  $('#m_prev').addEventListener('click', ()=>{ currentMonth = shiftMonth(currentMonth,-1); renderFx(); });
  $('#m_next').addEventListener('click', ()=>{ currentMonth = shiftMonth(currentMonth,+1); renderFx(); });
  $('#goto_ledger').addEventListener('click', ()=>{ tab='ledger'; render(); });

  $('#fx_btn_calc').addEventListener('click', ()=>{
    const res = fxCalcPreview();
    if (!res) return toast('è«‹è¼¸å…¥æ¸¯å¹£èˆ‡åŒ¯ç‡');
    toast('å·²è¨ˆç®—');
  });

  ['input','change'].forEach(evt=>{
    $('#fx_hkd_total').addEventListener(evt, fxCalcPreview);
    $('#fx_rate').addEventListener(evt, fxCalcPreview);
  });

  $('#fx_btn_copy').addEventListener('click', async ()=>{
    fxCalcPreview();
    if (!lastFxCopyText) return toast('å…ˆè¨ˆç®—');
    await copyText(lastFxCopyText);
  });

  $('#fx_btn_rate').addEventListener('click', ()=> window.open(RATE_HKDCNY,'_blank'));

  $('#fx_btn_clear').addEventListener('click', ()=>{
    $('#fx_hkd_total').value = '';
    $('#fx_rate').value = '';
    $('#fx_note').value = '';
    lastFx = null; lastFxCopyText='';
    fxCalcPreview();
    toast('å·²æ¸…ç©º');
  });

  $('#fx_btn_save').addEventListener('click', ()=>{
    const res = fxCalcPreview();
    if (!res) return toast('å…ˆè¼¸å…¥ä¸¦è¨ˆç®—');

    const note = ($('#fx_note').value || '').trim();

    const item = {
      id: uid(),
      type: 'exchange85',
      ts: nowISO(),
      month: currentMonth,
      hkdTotal: res.hkdTotal,
      hkd85: res.hkd85,
      rate: res.rate,
      rmbGiven: res.rmbGiven,
      note,
      rateUrl: RATE_HKDCNY
    };

    const all = loadLedger();
    all.push(item);
    all.sort((a,b)=>(a.ts||'').localeCompare(b.ts||''));
    saveLedger(all);

    toast('å·²å­˜å…¥è¨˜å¸³ç°¿');
    renderFx();
  });

  fxCalcPreview();
  renderMonth();
}

/* ===========================
   Ledger page (monthly + backup)
=========================== */
function renderLedger(){
  const all = loadLedger();
  const sum = monthSummary(all, currentMonth);

  panelLeft.innerHTML = `
    <div class="hd">
      <div>
        <div class="t">è¨˜å¸³ç°¿ï¼ˆæ°¸ä¹…ä¿å­˜ï½œæŒ‰æœˆæª¢ç´¢ï½œæ‰‹å‹•å¢åˆªï½œå‚™è¨»ï¼‰</div>
        <div class="s">æ–°å¢ï¼šå¯åŒ¯å‡º/åŒ¯å…¥å‚™ä»½ï¼ˆJSONï¼‰ï¼Œæ›æ‰‹æ©Ÿä¹Ÿä¸æ€•è³‡æ–™ä¸è¦‹ã€‚</div>
      </div>
      <div class="tag">æœˆä»½ï¼š<span class="mono">${currentMonth}</span></div>
    </div>
    <div class="bd">
      <div class="toolbar">
        <div class="left">
          <input id="ledger_month" type="month" value="${currentMonth}" style="max-width:180px" />
          <button class="smallbtn" id="ledger_prev">â—€</button>
          <button class="smallbtn" id="ledger_next">â–¶</button>
        </div>
        <div class="right">
          <button class="smallbtn" id="backup_export">åŒ¯å‡ºå‚™ä»½</button>
          <button class="smallbtn" id="backup_import">åŒ¯å…¥å‚™ä»½</button>
          <input id="backup_file" type="file" accept="application/json" style="display:none" />
          <button class="smallbtn" id="open_hkdcny">HKDâ†’CNY</button>
          <button class="smallbtn" id="open_cnytwd">CNYâ†’TWD</button>
        </div>
      </div>

      <div class="note">
        å‚™ä»½è¦å‰‡ï¼šåŒ¯å…¥æ™‚æœƒã€Œåˆä½µã€è³‡æ–™ï¼ˆåŒ ID ä¸é‡è¤‡ï¼‰ï¼Œä¸æœƒæŠŠä½ åŸæœ¬çš„è¨˜å¸³è¦†è“‹æ‰ã€‚
      </div>

      <div class="divider"></div>

      <div class="kpi">
        <div class="k">
          <div class="lbl">â‘¤ æœ¬æœˆç¸½æ›åŒ¯ RMBï¼ˆçµ¦å°æ–¹ï¼‰</div>
          <div class="val mono">${fmt(sum.sumFxRmb)}</div>
          <div class="sub">æ›åŒ¯ç­†æ•¸ï¼š${sum.fxCount}</div>
        </div>
        <div class="k">
          <div class="lbl">â‘¥ æœ¬æœˆç¸½æ”¶å…¥ HKD</div>
          <div class="val mono">${fmt(sum.sumIncomeHKD)}</div>
          <div class="sub">æ›åŒ¯æ”¶æ¬¾HKD + æ‰‹å‹•æ”¶å…¥HKD</div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="t" style="margin:0 0 6px">A) æ‰‹å‹•æ–°å¢ä¸€ç­†ï¼ˆå¯é¸å¹£åˆ¥ï¼‰</div>
      <div class="row">
        <div>
          <label for="add_type">é¡å‹</label>
          <select id="add_type">
            <option value="income">æ”¶å…¥</option>
            <option value="expense">æ”¯å‡º</option>
            <option value="adjust">èª¿æ•´</option>
          </select>
        </div>
        <div>
          <label for="add_currency">å¹£åˆ¥</label>
          <select id="add_currency">
            <option value="HKD">HKD</option>
            <option value="RMB">RMB</option>
            <option value="TWD">TWD</option>
          </select>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <div>
          <label for="add_amount">é‡‘é¡</label>
          <input id="add_amount" inputmode="decimal" placeholder="ä¾‹å¦‚ï¼š3000" />
        </div>
        <div>
          <label for="add_note">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
          <input id="add_note" placeholder="ä¾‹å¦‚ï¼šæŸç­†æ”¶å…¥/æŸç­†æ”¯å‡º" />
        </div>
      </div>
      <div class="actions">
        <button class="btn-primary" id="add_save">æ–°å¢åˆ°æœ¬æœˆ</button>
        <button class="btn-danger" id="add_clear">æ¸…ç©ºæ¬„ä½</button>
      </div>

      <div class="divider"></div>

      <div class="t" style="margin:0 0 6px">B) RMBâ†’TWD æ›åŒ¯è¨˜éŒ„ï¼ˆæ‰‹å‹•åŒ¯ç‡ï¼‹å‚™è¨»ï¼‰</div>
      <div class="row">
        <div>
          <label for="rt_rmb">ä½¿ç”¨ RMB</label>
          <input id="rt_rmb" inputmode="decimal" placeholder="ä¾‹å¦‚ï¼š1000" />
        </div>
        <div>
          <label for="rt_rate">åŒ¯ç‡ï¼ˆ1 CNY/RMB = ? TWDï¼‰</label>
          <input id="rt_rate" inputmode="decimal" placeholder="ä¾‹å¦‚ï¼š4.35" />
        </div>
      </div>
      <div style="margin-top:10px">
        <label for="rt_note">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
        <input id="rt_note" placeholder="ä¾‹å¦‚ï¼šæ›å°å¹£ç”¨é€”/çµ¦èª°/å“ªç­†" />
      </div>
      <div class="actions">
        <button class="btn-ghost" id="rt_preview">å…ˆç®—ä¸€ä¸‹</button>
        <button class="btn-primary" id="rt_save">å­˜å…¥ RMBâ†’TWD è¨˜éŒ„</button>
        <button class="btn-ghost" id="rt_copy">è¤‡è£½æœ¬æ¬¡æ˜ç´°</button>
      </div>
      <div class="note mono" id="rt_box">è¼¸å…¥ RMB èˆ‡åŒ¯ç‡å¾Œå¯å…ˆç®—ä¸€ä¸‹ã€‚åŒ¯ç‡æŸ¥è©¢è«‹é» CNYâ†’TWD é€£çµã€‚</div>
    </div>
  `;

  panelRight.innerHTML = `
    <div class="hd">
      <div>
        <div class="t">æœ¬æœˆæ˜ç´°ï¼ˆå¯åˆªé™¤ï¼‰</div>
        <div class="s">æ›åŒ¯ / æ‰‹å‹•æ”¶å…¥æ”¯å‡º / RMBâ†’TWD éƒ½æœƒåˆ—åœ¨é€™è£¡ã€‚</div>
      </div>
      <div class="tag">æœ¬æœˆï¼š<span class="mono">${currentMonth}</span></div>
    </div>
    <div class="bd">
      <ul class="list" id="ledger_list"></ul>
    </div>
  `;

  function renderList(){
    const arr = loadLedger()
      .filter(x=>x.month===currentMonth)
      .slice()
      .sort((a,b)=>(b.ts||'').localeCompare(a.ts||''));

    const listEl = $('#ledger_list');
    if (!arr.length){
      listEl.innerHTML = `<li class="item muted">æœ¬æœˆå°šç„¡ç´€éŒ„</li>`;
      return;
    }

    listEl.innerHTML = '';
    for (const it of arr){
      const li = document.createElement('li');
      li.className = 'item';

      if (it.type === 'exchange85'){
        li.innerHTML = `
          <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start">
            <div>
              <div class="mono"><b>æ›åŒ¯</b> HKD ${fmt(it.hkdTotal)} â†’ 85% HKD ${fmt(it.hkd85)} Ã— ${fmt(it.rate,4)} = RMB ${fmt(it.rmbGiven)}ï¼ˆçµ¦å°æ–¹ï¼‰</div>
              ${it.note ? `<div class="muted" style="margin-top:4px">å‚™è¨»ï¼š${escapeHtml(it.note)}</div>` : ``}
              <div class="muted" style="margin-top:4px">${fmtTime(it.ts)} ãƒ» <a href="${it.rateUrl||RATE_HKDCNY}" target="_blank" rel="noreferrer">ğŸ”— åŒ¯ç‡é€£çµ</a></div>
            </div>
            <div style="white-space:nowrap">
              <button class="smallbtn" data-del="${it.id}">åˆªé™¤</button>
            </div>
          </div>
        `;
      } else if (it.type === 'rmb_to_twd'){
        li.innerHTML = `
          <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start">
            <div>
              <div class="mono"><b>RMBâ†’TWD</b> RMB ${fmt(it.rmb)} Ã— ${fmt(it.rate,4)} = TWD ${fmt(it.twd)}</div>
              ${it.note ? `<div class="muted" style="margin-top:4px">å‚™è¨»ï¼š${escapeHtml(it.note)}</div>` : ``}
              <div class="muted" style="margin-top:4px">${fmtTime(it.ts)} ãƒ» <a href="${RATE_CNYTWD}" target="_blank" rel="noreferrer">ğŸ”— CNYâ†’TWD</a></div>
            </div>
            <div style="white-space:nowrap">
              <button class="smallbtn" data-del="${it.id}">åˆªé™¤</button>
            </div>
          </div>
        `;
      } else {
        const label = it.type === 'income' ? 'æ”¶å…¥' : it.type === 'expense' ? 'æ”¯å‡º' : 'èª¿æ•´';
        li.innerHTML = `
          <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start">
            <div>
              <div class="mono"><b>${label}</b> ${it.currency} ${fmt(Number(it.amount)||0)}</div>
              ${it.note ? `<div class="muted" style="margin-top:4px">å‚™è¨»ï¼š${escapeHtml(it.note)}</div>` : ``}
              <div class="muted" style="margin-top:4px">${fmtTime(it.ts)}</div>
            </div>
            <div style="white-space:nowrap">
              <button class="smallbtn" data-del="${it.id}">åˆªé™¤</button>
            </div>
          </div>
        `;
      }

      listEl.appendChild(li);
    }

    listEl.querySelectorAll('[data-del]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.getAttribute('data-del');
        const kept = loadLedger().filter(x=>x.id!==id);
        saveLedger(kept);
        toast('å·²åˆªé™¤');
        renderLedger();
      });
    });
  }

  // month controls
  $('#ledger_month').addEventListener('change', ()=>{
    const v = $('#ledger_month').value;
    if (v) currentMonth = v;
    renderLedger();
  });
  $('#ledger_prev').addEventListener('click', ()=>{ currentMonth = shiftMonth(currentMonth,-1); renderLedger(); });
  $('#ledger_next').addEventListener('click', ()=>{ currentMonth = shiftMonth(currentMonth,+1); renderLedger(); });

  // open links
  $('#open_hkdcny').addEventListener('click', ()=> window.open(RATE_HKDCNY,'_blank'));
  $('#open_cnytwd').addEventListener('click', ()=> window.open(RATE_CNYTWD,'_blank'));

  // backup export/import
  $('#backup_export').addEventListener('click', exportBackup);
  $('#backup_import').addEventListener('click', ()=> $('#backup_file').click());
  $('#backup_file').addEventListener('change', async (e)=>{
    const file = e.target.files && e.target.files[0];
    e.target.value = ''; // allow reselect same file next time
    if (!file) return;
    const res = await importBackupFromFile(file);
    if (!res.ok) return toast(res.msg);
    toast(res.msg);
    renderLedger();
  });

  // manual add
  $('#add_save').addEventListener('click', ()=>{
    const type = $('#add_type').value;
    const currency = $('#add_currency').value;
    const amount = toNum($('#add_amount').value);
    const note = ($('#add_note').value||'').trim();

    if (!Number.isFinite(amount) || amount <= 0) return toast('è«‹è¼¸å…¥é‡‘é¡');

    const item = {
      id: uid(),
      type,
      currency,
      amount,
      note,
      ts: nowISO(),
      month: currentMonth
    };

    const all2 = loadLedger();
    all2.push(item);
    all2.sort((a,b)=>(a.ts||'').localeCompare(b.ts||''));
    saveLedger(all2);

    toast('å·²æ–°å¢');
    $('#add_amount').value='';
    $('#add_note').value='';
    renderLedger();
  });

  $('#add_clear').addEventListener('click', ()=>{
    $('#add_amount').value='';
    $('#add_note').value='';
    toast('å·²æ¸…ç©ºæ¬„ä½');
  });

  // RMB->TWD tool
  function calcRmbToTwd(){
    const rmb = toNum($('#rt_rmb').value);
    const rate = toNum($('#rt_rate').value);
    if (!Number.isFinite(rmb) || rmb<=0) return null;
    if (!Number.isFinite(rate) || rate<=0) return null;
    const twd = rmb * rate;
    return { rmb, rate, twd };
  }

  $('#rt_preview').addEventListener('click', ()=>{
    const res = calcRmbToTwd();
    if (!res) return toast('è«‹è¼¸å…¥ RMB èˆ‡åŒ¯ç‡');
    $('#rt_box').textContent = `æœ¬æ¬¡ï¼šRMB ${fmt(res.rmb)} Ã— ${fmt(res.rate,4)} = TWD ${fmt(res.twd)}`;
    toast('å·²è¨ˆç®—');
  });

  $('#rt_copy').addEventListener('click', async ()=>{
    const res = calcRmbToTwd();
    if (!res) return toast('è«‹è¼¸å…¥ RMB èˆ‡åŒ¯ç‡');
    const note = ($('#rt_note').value||'').trim();
    const text =
`æ›åŒ¯è¨˜éŒ„ï¼ˆRMBâ†’TWDï¼‰
ä½¿ç”¨ RMBï¼š${fmt(res.rmb)}
åŒ¯ç‡ï¼š1 CNY/RMB = ${fmt(res.rate,4)} TWD
æ›å¾— TWDï¼š${fmt(res.twd)}
æ™‚é–“ï¼š${nowStr()}${note ? `\nå‚™è¨»ï¼š${note}` : ''}`;
    await copyText(text);
  });

  $('#rt_save').addEventListener('click', ()=>{
    const res = calcRmbToTwd();
    if (!res) return toast('è«‹è¼¸å…¥ RMB èˆ‡åŒ¯ç‡');
    const note = ($('#rt_note').value||'').trim();

    const item = {
      id: uid(),
      type: 'rmb_to_twd',
      ts: nowISO(),
      month: currentMonth,
      rmb: res.rmb,
      rate: res.rate,
      twd: res.twd,
      note
    };

    const all2 = loadLedger();
    all2.push(item);
    all2.sort((a,b)=>(a.ts||'').localeCompare(b.ts||''));
    saveLedger(all2);

    $('#rt_rmb').value='';
    $('#rt_rate').value='';
    $('#rt_note').value='';
    $('#rt_box').textContent = 'å·²å­˜å…¥ RMBâ†’TWD è¨˜éŒ„ã€‚';

    toast('å·²å­˜å…¥ RMBâ†’TWD');
    renderLedger();
  });

  renderList();
}

/* ===========================
   Boot
=========================== */
function updateNetPill(){
  const el = $('#netStatus');
  el.textContent = navigator.onLine ? 'ç›®å‰ç‹€æ…‹ï¼šåœ¨ç·š' : 'ç›®å‰ç‹€æ…‹ï¼šé›¢ç·šï¼ˆä»å¯ç”¨ï¼‰';
}
window.addEventListener('online', updateNetPill);
window.addEventListener('offline', updateNetPill);

render();
updateNetPill();
</script>
</body>
</html>
