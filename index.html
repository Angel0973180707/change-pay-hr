<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b3d2e" />
  <title>æ¸¯å¹£â†’äººæ°‘å¹£ï½œæ‰¹æ¬¡åŠ ç¸½Ã—æŒ‰æœˆè¨˜å¸³Ã—é¤˜é¡</title>

  <link rel="manifest" href="./manifest.json" />
  <link rel="apple-touch-icon" href="./icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />

  <style>
    :root{
      --bg:#0b3d2e;
      --card:#ffffff;
      --text:#102018;
      --muted:#66746c;
      --line:#e6eee9;
      --soft:#f4faf7;
      --accent:#1f7a5b;
      --danger:#b42318;
      --warn:#b54708;
      --shadow:0 10px 24px rgba(16,32,24,.10);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", Arial, sans-serif;
      background:linear-gradient(180deg, #073023 0%, #0b3d2e 40%, #083226 100%);
      color:#fff;
      min-height:100vh;
    }
    .wrap{max-width:1120px;margin:0 auto;padding:18px 14px 44px}
    .top{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      padding:10px 6px 10px;
    }
    .brand h1{margin:0;font-size:20px;letter-spacing:.5px}
    .brand p{margin:6px 0 0;color:rgba(255,255,255,.82);font-size:13px;line-height:1.4}
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:8px 10px; border:1px solid rgba(255,255,255,.18);
      border-radius:999px; font-size:12px; color:rgba(255,255,255,.9);
      background:rgba(255,255,255,.06);
      user-select:none;
      white-space:nowrap;
    }
    .tabs{
      display:flex; gap:10px; flex-wrap:wrap;
      padding:0 6px 14px;
    }
    .tab{
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.92);
      padding:10px 12px;
      border-radius:999px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      background:rgba(255,255,255,.14);
      border-color:rgba(255,255,255,.30);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:12px;
    }
    @media (max-width:940px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      background:var(--card);
      color:var(--text);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      border:1px solid rgba(16,32,24,.06);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      background:linear-gradient(180deg, #ffffff 0%, #fbfdfc 100%);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .card .hd .t{font-weight:900; font-size:15px}
    .card .hd .s{margin-top:6px; color:var(--muted); font-size:12px; line-height:1.4}
    .card .bd{padding:14px}

    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    @media (max-width:520px){ .row{grid-template-columns:1fr} }

    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input, textarea, select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
      font-size:16px;
      outline:none;
    }
    textarea{min-height:120px; resize:vertical; font-size:14px}
    input:focus, textarea:focus, select:focus{border-color:rgba(31,122,91,.45); box-shadow:0 0 0 4px rgba(31,122,91,.12)}

    .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    button{
      border:0;
      border-radius:14px;
      padding:12px 14px;
      font-weight:900;
      cursor:pointer;
      box-shadow:0 8px 18px rgba(16,32,24,.10);
    }
    .btn-primary{background:var(--accent); color:#fff}
    .btn-ghost{background:var(--soft); color:var(--text); border:1px solid var(--line); box-shadow:none}
    .btn-danger{background:#fff; color:var(--danger); border:1px solid rgba(180,35,24,.25); box-shadow:none}
    .btn-warn{background:#fff; color:var(--warn); border:1px solid rgba(181,71,8,.25); box-shadow:none}

    .note{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      background:var(--soft);
      border:1px dashed rgba(31,122,91,.25);
      color:#1f3b2f;
      font-size:12px;
      line-height:1.6;
    }

    .kpi{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .k{
      padding:12px;
      border-radius:16px;
      border:1px solid var(--line);
      background:#fff;
    }
    .k .lbl{font-size:12px;color:var(--muted)}
    .k .val{margin-top:8px;font-size:20px;font-weight:900;letter-spacing:.2px}
    .k .sub{margin-top:6px;font-size:12px;color:var(--muted)}
    .divider{height:1px;background:var(--line);margin:12px 0}

    .list{
      margin:0; padding:0; list-style:none;
      max-height:460px; overflow:auto;
    }
    .item{
      padding:10px 0; border-bottom:1px solid var(--line);
      font-size:12px;
    }
    .item:last-child{border-bottom:0}

    .mono{font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .muted{color:var(--muted)}
    .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background:var(--soft);
      font-size:11px;
      font-weight:900;
      color:#0b3d2e;
    }
    .tag.out{color:var(--danger)}
    .tag.in{color:var(--accent)}
    .tag.fx{color:#0b3d2e}
    .tag.tw{color:#0b3d2e}

    .toolbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .toolbar .left{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .toolbar .right{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .smallbtn{
      padding:10px 12px;
      border-radius:12px;
      font-weight:900;
      border:1px solid var(--line);
      background:var(--soft);
      box-shadow:none;
      cursor:pointer;
    }

    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background:rgba(0,0,0,.78); color:#fff;
      padding:10px 12px; border-radius:999px;
      font-size:12px; opacity:0; pointer-events:none;
      transition:opacity .18s ease;
      z-index:50;
    }
    .toast.show{opacity:1}
    .footer{
      margin-top:14px;
      color:rgba(255,255,255,.85);
      font-size:12px;
      padding:0 6px;
      line-height:1.65;
    }
    a{color:#1f7a5b}
    .footer a{color:#d9fff2}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <h1>æ¸¯å¹£ â†’ äººæ°‘å¹£ï½œæ‰¹æ¬¡åŠ ç¸½ Ã— æŒ‰æœˆè¨˜å¸³ Ã— é¤˜é¡</h1>
        <p>å¤šç­† HKD å…ˆåŠ ç¸½â†’çµå¸³æ›åŒ¯ï¼›æˆ‘ç•™è‡ªå‹•é€²é¤˜é¡ï¼›é¤˜é¡å¯é ˜å‡º/å­˜å…¥ï¼›æ–°å¢ï¼šRMBâ†’TWD æ›åŒ¯è¨˜éŒ„ï¼ˆæœƒæ‰£é¤˜é¡ï¼‰ã€‚</p>
      </div>
      <div class="pill" id="netStatus">ç‹€æ…‹ï¼šâ€”</div>
    </div>

    <div class="tabs">
      <div class="tab" data-tab="batch">æ‰¹æ¬¡åŠ ç¸½</div>
      <div class="tab" data-tab="pay">æ›åŒ¯çµå¸³</div>
      <div class="tab" data-tab="ledger">è¨˜å¸³èˆ‡é¤˜é¡</div>
    </div>

    <div class="grid">
      <section class="card" id="panelLeft"></section>
      <section class="card" id="panelRight"></section>
    </div>

    <div class="footer">
      <div>âœ… åŒ¯ç‡æŸ¥è©¢ï¼ˆä½ æŒ‡å®šçš„é€£çµï¼‰ï¼š<a href="https://gu.sina.cn/quotes/fx/HKDCNY" target="_blank" rel="noreferrer">HKD/CNY</a></div>
      <div class="muted">æé†’ï¼šæ­¤å·¥å…·ä¸è‡ªå‹•æŠ“åŒ¯ç‡ï¼ˆè·¨åŸŸé™åˆ¶ï¼‰ï¼Œä½ æŸ¥å®ŒæŠŠåŒ¯ç‡å¡«å›ä¾†å³å¯ã€‚</div>
    </div>
  </div>

  <div class="toast" id="toast">å®Œæˆ</div>

<script>
/* ===========================
   PWA register
=========================== */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', async () => {
    try { await navigator.serviceWorker.register('./sw.js', { scope: './' }); } catch (e) {}
  });
}

/* ===========================
   Helpers
=========================== */
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => Array.from(document.querySelectorAll(sel));

function toast(msg='å®Œæˆ'){
  const el = $('#toast');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(()=>el.classList.remove('show'), 1200);
}

async function copyText(text){
  try{
    await navigator.clipboard.writeText(text);
    toast('å·²è¤‡è£½');
  }catch{
    const ta = document.createElement('textarea');
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    ta.remove();
    toast('å·²è¤‡è£½');
  }
}

function toNum(v){
  if (v === null || v === undefined) return NaN;
  const s = String(v).replace(/,/g,'').trim();
  return s === '' ? NaN : Number(s);
}

function fmt(n, digits=2){
  if (!Number.isFinite(n)) return 'â€”';
  return n.toLocaleString('zh-Hant', { minimumFractionDigits: digits, maximumFractionDigits: digits });
}
function pad2(x){ return String(x).padStart(2,'0'); }
function yyyymm(d=new Date()){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}`; }
function nowISO(){ return new Date().toISOString(); }
function nowStr(){
  const d=new Date();
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}
function fmtTime(iso){
  if (!iso) return '';
  try{
    const d = new Date(iso);
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
  }catch{ return iso; }
}
function escapeHtml(s){
  return String(s)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#39;");
}
function uid(){
  return Math.random().toString(16).slice(2) + Date.now().toString(16);
}
function shiftMonth(ym, delta){
  const [y,m] = ym.split('-').map(Number);
  const d = new Date(y, (m-1)+delta, 1);
  return yyyymm(d);
}

/* ===========================
   Storage Keys
=========================== */
const RATE_URL = 'https://gu.sina.cn/quotes/fx/HKDCNY';
const LS_LEDGER = 'change_pay_hr_ledger_v21';
const LS_BATCH  = 'change_pay_hr_batch_v21';
const LS_PREF   = 'change_pay_hr_pref_v21';

/*
  Ledger item types:
  - exchange:      HKD->RMB çµå¸³ï¼ˆmeRmb è‡ªå‹•ç´¯ç©ï¼‰
  - balance_in:    æ‰‹å‹•å­˜å…¥ RMB
  - balance_out:   æ‰‹å‹•é ˜å‡º RMB
  - rmb_to_twd:    RMB->TWD æ›åŒ¯è¨˜éŒ„ï¼ˆRMB æœƒå¾é¤˜é¡æ‰£é™¤ï¼‰
*/

function loadLedger(){
  try{
    const arr = JSON.parse(localStorage.getItem(LS_LEDGER) || '[]');
    return Array.isArray(arr) ? arr : [];
  }catch{ return []; }
}
function saveLedger(arr){
  localStorage.setItem(LS_LEDGER, JSON.stringify(arr));
}
function loadBatch(){
  try{
    const obj = JSON.parse(localStorage.getItem(LS_BATCH) || '{"items":[]}');
    if (!obj || typeof obj !== 'object') return { items: [] };
    if (!Array.isArray(obj.items)) obj.items = [];
    return obj;
  }catch{ return { items: [] }; }
}
function saveBatch(obj){
  localStorage.setItem(LS_BATCH, JSON.stringify(obj));
}
function loadPref(){
  try{
    const obj = JSON.parse(localStorage.getItem(LS_PREF) || '{}');
    return obj && typeof obj === 'object' ? obj : {};
  }catch{ return {}; }
}
function savePref(obj){
  localStorage.setItem(LS_PREF, JSON.stringify(obj || {}));
}

function calcBalance(all){
  // é¤˜é¡ï¼ˆRMBï¼‰= Î£(meRmb from exchange) + Î£(balance_in) - Î£(balance_out) - Î£(rmb_to_twd.rmb)
  let bal = 0;
  for (const it of all){
    if (it.type === 'exchange') bal += (Number(it.meRmb) || 0);
    if (it.type === 'balance_in') bal += (Number(it.amountRmb) || 0);
    if (it.type === 'balance_out') bal -= (Number(it.amountRmb) || 0);
    if (it.type === 'rmb_to_twd') bal -= (Number(it.rmb) || 0);
  }
  return bal;
}

function monthSummary(all, month){
  const items = all.filter(x => x.month === month);
  let sumHKD=0, sumRmb=0, sumOther=0, sumMe=0, sumIn=0, sumOut=0;
  let sumRmbToTwdRmb=0, sumRmbToTwdTwd=0;

  for (const it of items){
    if (it.type === 'exchange'){
      sumHKD += Number(it.hkd)||0;
      sumRmb += Number(it.totalRmb)||0;
      sumOther += Number(it.otherRmb)||0;
      sumMe += Number(it.meRmb)||0;
    }
    if (it.type === 'balance_in') sumIn += Number(it.amountRmb)||0;
    if (it.type === 'balance_out') sumOut += Number(it.amountRmb)||0;

    if (it.type === 'rmb_to_twd'){
      sumRmbToTwdRmb += Number(it.rmb)||0;
      sumRmbToTwdTwd += Number(it.twd)||0;
    }
  }
  return { count: items.length, sumHKD, sumRmb, sumOther, sumMe, sumIn, sumOut, sumRmbToTwdRmb, sumRmbToTwdTwd };
}

/* ===========================
   UI State
=========================== */
const pref = loadPref();
let currentTab = pref.tab || 'batch';
let currentMonth = pref.month || yyyymm(new Date());

const panelLeft = $('#panelLeft');
const panelRight = $('#panelRight');

/* ===========================
   Render root
=========================== */
function render(){
  $$('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === currentTab));
  pref.tab = currentTab;
  pref.month = currentMonth;
  savePref(pref);

  if (currentTab === 'batch') renderBatch();
  if (currentTab === 'pay') renderPay();
  if (currentTab === 'ledger') renderLedger();
  updateNetPill();
}

/* ===========================
   Tab events
=========================== */
$$('.tab').forEach(t=>{
  t.addEventListener('click', ()=>{
    currentTab = t.dataset.tab;
    render();
  });
});

/* ===========================
   Batch: å¤šç­† HKD åŠ ç¸½
=========================== */
function renderBatch(){
  const batch = loadBatch();
  const items = batch.items || [];
  const sumHKD = items.reduce((a,x)=>a + (Number(x.amount)||0), 0);

  const ledger = loadLedger();
  const bal = calcBalance(ledger);

  panelLeft.innerHTML = `
    <div class="hd">
      <div>
        <div class="t">æ‰¹æ¬¡åŠ ç¸½ï¼ˆå¤šç­† HKD å…ˆåŠ ç¸½ï¼‰</div>
        <div class="s">åŠ å…¥å¤šç­† HKD â†’ è‡ªå‹•åŠ ç¸½ â†’ ä¸€éµå¸¶å…¥ã€Œæ›åŒ¯çµå¸³ã€ã€‚æ¸…å–®æœƒä¿ç•™ï¼Œä¸æ€•é—œæ‰ã€‚</div>
      </div>
      <div class="tag in">é¤˜é¡ï¼š<span class="mono">${fmt(bal)}</span> RMB</div>
    </div>
    <div class="bd">
      <div class="row">
        <div>
          <label for="batch_amount">æ–°å¢ä¸€ç­† HKD é‡‘é¡</label>
          <input id="batch_amount" inputmode="decimal" placeholder="ä¾‹å¦‚ï¼š500" />
        </div>
        <div>
          <label for="batch_note">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
          <input id="batch_note" placeholder="ä¾‹å¦‚ï¼šæŸå®¢æˆ¶/ç¬¬1ç­†" />
        </div>
      </div>

      <div class="actions">
        <button class="btn-primary" id="batch_add">åŠ å…¥æ¸…å–®</button>
        <button class="btn-ghost" id="batch_paste">å¾å‰ªè²¼ç°¿è²¼ä¸Šï¼ˆå¤šè¡Œï¼‰</button>
        <button class="btn-warn" id="batch_to_pay">å¸¶å…¥ã€Œæ›åŒ¯çµå¸³ã€</button>
        <button class="btn-danger" id="batch_clear">æ¸…ç©ºæ¸…å–®</button>
      </div>

      <div class="note">
        ä½ å¯ä»¥è²¼ä¸Šå¤šç­†é‡‘é¡ï¼ˆæ¯è¡Œä¸€ç­†ï¼‰ï¼Œä¾‹å¦‚ï¼š<br/>
        500<br/>1200<br/>300<br/>
        ç³»çµ±æœƒè‡ªå‹•æŠ“æ•¸å­—åŠ å…¥æ¸…å–®ä¸¦åŠ ç¸½ã€‚
      </div>
    </div>
  `;

  panelRight.innerHTML = `
    <div class="hd">
      <div>
        <div class="t">æœ¬æ¬¡åŠ ç¸½</div>
        <div class="s">HKD åˆè¨ˆæœƒé¡¯ç¤ºåœ¨å³ä¸Šè§’ï¼Œä¸¦å¯ä¸€éµå¸¶å…¥çµå¸³ã€‚</div>
      </div>
      <div class="tag">HKD åˆè¨ˆï¼š<span class="mono" id="batch_sum">${fmt(sumHKD)}</span></div>
    </div>
    <div class="bd">
      <div class="kpi">
        <div class="k">
          <div class="lbl">ç­†æ•¸</div>
          <div class="val mono">${items.length}</div>
          <div class="sub">å¯æŒçºŒç´¯åŠ </div>
        </div>
        <div class="k">
          <div class="lbl">HKD åˆè¨ˆ</div>
          <div class="val mono">${fmt(sumHKD)}</div>
          <div class="sub">å¸¶å…¥çµå¸³</div>
        </div>
      </div>

      <div class="divider"></div>
      <div style="font-weight:900;margin-bottom:6px">æ¸…å–®</div>
      <ul class="list" id="batch_list"></ul>
    </div>
  `;

  const listEl = $('#batch_list');

  function renderList(){
    const b = loadBatch();
    const its = b.items || [];
    const sum = its.reduce((a,x)=>a + (Number(x.amount)||0), 0);
    $('#batch_sum').textContent = fmt(sum);

    if (!its.length){
      listEl.innerHTML = `<li class="item muted">å°šç„¡æ¸…å–®</li>`;
      return;
    }
    listEl.innerHTML = '';
    its.forEach((it, idx)=>{
      const li = document.createElement('li');
      li.className = 'item';
      li.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:10px">
          <div>
            <div class="mono"><b>HKD</b> ${fmt(it.amount)}</div>
            ${it.note ? `<div class="muted" style="margin-top:4px">å‚™è¨»ï¼š${escapeHtml(it.note)}</div>` : ``}
            <div class="muted" style="margin-top:4px">${it.time || ''}</div>
          </div>
          <div style="white-space:nowrap">
            <button class="smallbtn" data-rm="${idx}">åˆªé™¤</button>
          </div>
        </div>
      `;
      listEl.appendChild(li);
    });

    listEl.querySelectorAll('[data-rm]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const i = Number(btn.getAttribute('data-rm'));
        const b2 = loadBatch();
        b2.items.splice(i,1);
        saveBatch(b2);
        toast('å·²åˆªé™¤');
        renderList();
      });
    });
  }

  $('#batch_add').addEventListener('click', ()=>{
    const amt = toNum($('#batch_amount').value);
    const note = ($('#batch_note').value || '').trim();
    if (!Number.isFinite(amt) || amt <= 0) return toast('è«‹è¼¸å…¥é‡‘é¡');

    const b = loadBatch();
    b.items = b.items || [];
    b.items.push({ amount: amt, note, time: nowStr() });
    saveBatch(b);

    $('#batch_amount').value = '';
    $('#batch_note').value = '';
    toast('å·²åŠ å…¥');
    renderList();
  });

  $('#batch_paste').addEventListener('click', async ()=>{
    try{
      const text = await navigator.clipboard.readText();
      if (!text) return toast('å‰ªè²¼ç°¿æ²’æœ‰å…§å®¹');
      const nums = text
        .split(/\r?\n|,|\s+/g)
        .map(s=>s.trim())
        .filter(Boolean)
        .map(s=>Number(String(s).replace(/[^0-9.\-]/g,'')))
        .filter(n=>Number.isFinite(n) && n > 0);

      if (!nums.length) return toast('æ²’æŠ“åˆ°æ•¸å­—');
      const b = loadBatch();
      b.items = b.items || [];
      for (const n of nums){
        b.items.push({ amount: n, note: 'è²¼ä¸Š', time: nowStr() });
      }
      saveBatch(b);
      toast(`å·²è²¼ä¸Š ${nums.length} ç­†`);
      renderList();
    }catch{
      toast('ç„¡æ³•è®€å–å‰ªè²¼ç°¿ï¼ˆå¯æ”¹ç”¨æ‰‹å‹•åŠ å…¥ï¼‰');
    }
  });

  $('#batch_clear').addEventListener('click', ()=>{
    saveBatch({ items: [] , sumHKD: 0 });
    toast('å·²æ¸…ç©º');
    renderBatch();
  });

  $('#batch_to_pay').addEventListener('click', ()=>{
    const b = loadBatch();
    const sum = (b.items||[]).reduce((a,x)=>a+(Number(x.amount)||0),0);
    if (!sum) return toast('æ¸…å–®æ˜¯ç©ºçš„');

    b.sumHKD = sum;
    b.injectId = uid();
    saveBatch(b);

    currentTab = 'pay';
    toast('å·²å¸¶å…¥çµå¸³ï¼ˆå¡«å…¥ HKDï¼‰');
    render();
  });

  renderList();
}

/* ===========================
   Pay: HKD->RMB çµå¸³ï¼ˆæˆ‘ç•™è‡ªå‹•é€²é¤˜é¡ï¼‰
=========================== */
function renderPay(){
  const all = loadLedger();
  const bal = calcBalance(all);
  const batch = loadBatch();
  const sumHKD = Number(batch.sumHKD || 0);

  panelLeft.innerHTML = `
    <div class="hd">
      <div>
        <div class="t">æ›åŒ¯çµå¸³ï¼ˆHKD â†’ RMBï¼‰</div>
        <div class="s">RMBç¸½é¡ = HKD Ã— åŒ¯ç‡ï¼›çµå¸³å¾Œã€Œæˆ‘ç•™ã€æœƒè‡ªå‹•åŠ é€²é¤˜é¡ï¼Œä¸¦æ°¸ä¹…è¨˜å¸³ï¼ˆæŒ‰æœˆæª¢ç´¢ï¼‰ã€‚</div>
      </div>
      <div class="tag in">é¤˜é¡ï¼š<span class="mono">${fmt(bal)}</span> RMB</div>
    </div>
    <div class="bd">
      <div class="row">
        <div>
          <label for="pay_hkd">æœ¬æ¬¡æ¸¯å¹£ç¸½é¡ HKD</label>
          <input id="pay_hkd" inputmode="decimal" placeholder="ä¾‹å¦‚ï¼š1000" />
        </div>
        <div>
          <label for="pay_rate">åŒ¯ç‡ï¼ˆ1 HKD = ? RMBï¼‰</label>
          <input id="pay_rate" inputmode="decimal" placeholder="ä¾‹å¦‚ï¼š0.92" />
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div>
          <label for="pay_pctOther">çµ¦å°æ–¹æ¯”ä¾‹ï¼ˆ%ï¼‰</label>
          <input id="pay_pctOther" inputmode="decimal" value="85" />
        </div>
        <div>
          <label for="pay_pctMe">æˆ‘ç•™æ¯”ä¾‹ï¼ˆ%ï¼‰</label>
          <input id="pay_pctMe" inputmode="decimal" value="15" />
        </div>
      </div>

      <div style="margin-top:10px">
        <label for="pay_note">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
        <input id="pay_note" placeholder="ä¾‹å¦‚ï¼šAå®¢æˆ¶/æŸç­†è¨‚å–®" />
      </div>

      <div class="actions">
        <button class="btn-primary" id="pay_save">è¨ˆç®—ï¼‹å­˜å…¥çµå¸³</button>
        <button class="btn-ghost" id="pay_rate_link">æŸ¥ä»Šæ—¥åŒ¯ç‡</button>
        <button class="btn-ghost" id="pay_copy_other">è¤‡è£½ã€Œçµ¦å°æ–¹ã€</button>
        <button class="btn-ghost" id="pay_copy_all">è¤‡è£½å®Œæ•´æ˜ç´°</button>
        <button class="btn-danger" id="pay_clear">æ¸…ç©º</button>
      </div>

      <div class="note">
        âœ… è‹¥ä½ å‰›å¾ã€Œæ‰¹æ¬¡åŠ ç¸½ã€å¸¶å…¥ï¼ŒHKD æœƒè‡ªå‹•å¡«å…¥ã€‚<br/>
        âœ… çµå¸³æˆåŠŸå¾Œï¼Œä½ å¯ä»¥é¸æ“‡è¦ä¸è¦æ¸…ç©ºæ‰¹æ¬¡æ¸…å–®ï¼ˆé¿å…é‡è¤‡çµå¸³ï¼‰ã€‚
      </div>
    </div>
  `;

  panelRight.innerHTML = `
    <div class="hd">
      <div>
        <div class="t">æœ¬æ¬¡è¨ˆç®—çµæœï¼ˆé è¦½ï¼‰</div>
        <div class="s">ä½ è¼¸å…¥å°±æœƒç®—ï¼›æŒ‰ã€Œå­˜å…¥çµå¸³ã€æ‰æœƒå¯«å…¥è¨˜å¸³èˆ‡é¤˜é¡ã€‚</div>
      </div>
      <div class="tag">æœˆä»½ï¼š<span class="mono">${currentMonth}</span></div>
    </div>
    <div class="bd">
      <div class="kpi">
        <div class="k">
          <div class="lbl">å…Œæ›äººæ°‘å¹£ç¸½é¡ï¼ˆRMBï¼‰</div>
          <div class="val mono" id="pay_total">â€”</div>
          <div class="sub mono" id="pay_formula">â€”</div>
        </div>
        <div class="k">
          <div class="lbl">çµ¦å°æ–¹ï¼ˆRMBï¼‰</div>
          <div class="val mono" id="pay_other">â€”</div>
          <div class="sub">æ¯”ä¾‹ï¼š<span class="mono" id="pay_other_pct">85%</span></div>
        </div>
        <div class="k">
          <div class="lbl">æˆ‘ç•™ï¼ˆRMBï¼‰</div>
          <div class="val mono" id="pay_me">â€”</div>
          <div class="sub">æ¯”ä¾‹ï¼š<span class="mono" id="pay_me_pct">15%</span></div>
        </div>
        <div class="k">
          <div class="lbl">æ¯”ä¾‹æª¢æŸ¥</div>
          <div class="val mono" id="pay_chk">â€”</div>
          <div class="sub" id="pay_chk_hint">â€”</div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="toolbar">
        <div class="left">
          <div style="font-weight:900">æœ¬æœˆæ‘˜è¦</div>
          <span class="tag">æœ¬æœˆï¼š<span class="mono">${currentMonth}</span></span>
        </div>
        <div class="right">
          <button class="smallbtn" id="m_prev">â—€ ä¸Šæœˆ</button>
          <button class="smallbtn" id="m_next">ä¸‹æœˆ â–¶</button>
        </div>
      </div>

      <div class="note" id="pay_month_summary">â€”</div>

      <div class="divider"></div>
      <div style="font-weight:900;margin-bottom:6px">æœ¬æœˆæœ€è¿‘ç´€éŒ„</div>
      <ul class="list" id="pay_month_list"></ul>
    </div>
  `;

  const hkdEl = $('#pay_hkd');
  const rateEl = $('#pay_rate');
  const pctOEl = $('#pay_pctOther');
  const pctMEl = $('#pay_pctMe');

  if (!hkdEl.value && sumHKD > 0) hkdEl.value = String(sumHKD);

  function calcPreview(){
    const hkd = toNum(hkdEl.value);
    const rate = toNum(rateEl.value);
    let pctO = toNum(pctOEl.value);
    let pctM = toNum(pctMEl.value);
    if (!Number.isFinite(pctO)) pctO = 85;
    if (!Number.isFinite(pctM)) pctM = 15;

    $('#pay_other_pct').textContent = `${pctO}%`;
    $('#pay_me_pct').textContent = `${pctM}%`;

    if (!Number.isFinite(hkd) || !Number.isFinite(rate) || hkd < 0 || rate < 0){
      $('#pay_total').textContent = 'â€”';
      $('#pay_other').textContent = 'â€”';
      $('#pay_me').textContent = 'â€”';
      $('#pay_formula').textContent = 'è«‹è¼¸å…¥ HKD èˆ‡åŒ¯ç‡';
      $('#pay_chk').textContent = 'â€”';
      $('#pay_chk_hint').textContent = 'â€”';
      return null;
    }

    const total = hkd * rate;
    const other = total * (pctO/100);
    const me = total * (pctM/100);
    const sumPct = pctO + pctM;

    $('#pay_total').textContent = fmt(total);
    $('#pay_other').textContent = fmt(other);
    $('#pay_me').textContent = fmt(me);
    $('#pay_formula').textContent = `HKD ${fmt(hkd)} Ã— rate ${fmt(rate,4)} = RMB ${fmt(total)}`;

    $('#pay_chk').textContent = fmt(sumPct,2) + '%';
    if (Math.abs(sumPct - 100) > 0.0001){
      $('#pay_chk_hint').textContent = 'åŠ ç¸½ä¸æ˜¯ 100%ï¼Œä»å¯å­˜ï¼Œä½†å»ºè­°èª¿æ•´';
      $('#pay_chk_hint').style.color = '#b42318';
    }else{
      $('#pay_chk_hint').textContent = 'åŠ ç¸½ 100%ï¼ˆæ­£å¸¸ï¼‰';
      $('#pay_chk_hint').style.color = '#66746c';
    }

    return {hkd, rate, pctO, pctM, total, other, me};
  }

  function renderMonthBlock(){
    const all2 = loadLedger();
    const sum = monthSummary(all2, currentMonth);
    const bal2 = calcBalance(all2);

    $('#pay_month_summary').innerHTML =
      `æœ¬æœˆç­†æ•¸ï¼š<b class="mono">${sum.count}</b><br>` +
      `HKDâ†’RMBï½œHKD åˆè¨ˆï¼š<b class="mono">${fmt(sum.sumHKD)}</b>ï½œRMB ç¸½é¡ï¼š<b class="mono">${fmt(sum.sumRmb)}</b>ï½œå°æ–¹ï¼š<b class="mono">${fmt(sum.sumOther)}</b>ï½œæˆ‘ç•™ï¼š<b class="mono">${fmt(sum.sumMe)}</b><br>` +
      `é¤˜é¡èª¿æ•´ï½œå­˜å…¥ï¼š<b class="mono">${fmt(sum.sumIn)}</b>ï½œé ˜å‡ºï¼š<b class="mono">${fmt(sum.sumOut)}</b><br>` +
      `RMBâ†’TWDï½œç”¨ RMBï¼š<b class="mono">${fmt(sum.sumRmbToTwdRmb)}</b>ï½œæ›å¾— TWDï¼š<b class="mono">${fmt(sum.sumRmbToTwdTwd)}</b><br>` +
      `ç›®å‰ç´¯ç©é¤˜é¡ï¼ˆå…¨æœŸé–“ï¼‰ï¼š<b class="mono">${fmt(bal2)}</b> RMB`;

    const listEl = $('#pay_month_list');
    const items = all2
      .filter(x=>x.month===currentMonth)
      .slice()
      .sort((a,b)=>(b.ts||'').localeCompare(a.ts||''));

    if (!items.length){
      listEl.innerHTML = `<li class="item muted">æœ¬æœˆå°šç„¡ç´€éŒ„</li>`;
      return;
    }
    listEl.innerHTML = '';
    for (const it of items){
      const li = document.createElement('li');
      li.className = 'item';

      if (it.type === 'exchange'){
        li.innerHTML = `
          <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start">
            <div>
              <div class="mono"><span class="tag in">çµå¸³</span> HKD ${fmt(it.hkd)} Ã— rate ${fmt(it.rate,4)} = RMB ${fmt(it.totalRmb)}</div>
              <div class="mono muted" style="margin-top:4px">å°æ–¹ ${fmt(it.otherRmb)}ï¼ˆ${it.pctOther}%ï¼‰ï½œæˆ‘ç•™ ${fmt(it.meRmb)}ï¼ˆ${it.pctMe}%ï¼‰</div>
              ${it.note ? `<div class="muted" style="margin-top:4px">å‚™è¨»ï¼š${escapeHtml(it.note)}</div>` : ``}
              <div class="muted" style="margin-top:4px">
                ${fmtTime(it.ts)} ãƒ» <a href="${it.rateUrl||RATE_URL}" target="_blank" rel="noreferrer">ğŸ”— åŒ¯ç‡ä¾†æº</a>
              </div>
            </div>
            <div style="white-space:nowrap">
              <button class="smallbtn" data-del="${it.id}">åˆªé™¤</button>
            </div>
          </div>
        `;
      } else if (it.type === 'balance_in') {
        li.innerHTML = `
          <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start">
            <div>
              <div class="mono"><span class="tag in">å­˜å…¥</span> RMB +${fmt(it.amountRmb)}</div>
              ${it.note ? `<div class="muted" style="margin-top:4px">å‚™è¨»ï¼š${escapeHtml(it.note)}</div>` : ``}
              <div class="muted" style="margin-top:4px">${fmtTime(it.ts)}</div>
            </div>
            <div style="white-space:nowrap">
              <button class="smallbtn" data-del="${it.id}">åˆªé™¤</button>
            </div>
          </div>
        `;
      } else if (it.type === 'balance_out') {
        li.innerHTML = `
          <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start">
            <div>
              <div class="mono"><span class="tag out">é ˜å‡º</span> RMB -${fmt(it.amountRmb)}</div>
              ${it.note ? `<div class="muted" style="margin-top:4px">å‚™è¨»ï¼š${escapeHtml(it.note)}</div>` : ``}
              <div class="muted" style="margin-top:4px">${fmtTime(it.ts)}</div>
            </div>
            <div style="white-space:nowrap">
              <button class="smallbtn" data-del="${it.id}">åˆªé™¤</button>
            </div>
          </div>
        `;
      } else {
        // rmb_to_twd
        li.innerHTML = `
          <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start">
            <div>
              <div class="mono"><span class="tag fx">RMBâ†’TWD</span> ç”¨ RMB ${fmt(it.rmb)} Ã— rate ${fmt(it.rate,4)} = TWD ${fmt(it.twd)}</div>
              ${it.note ? `<div class="muted" style="margin-top:4px">å‚™è¨»ï¼š${escapeHtml(it.note)}</div>` : ``}
              <div class="muted" style="margin-top:4px">${fmtTime(it.ts)}</div>
            </div>
            <div style="white-space:nowrap">
              <button class="smallbtn" data-del="${it.id}">åˆªé™¤</button>
            </div>
          </div>
        `;
      }

      listEl.appendChild(li);
    }

    listEl.querySelectorAll('[data-del]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.getAttribute('data-del');
        if (!id) return;
        const kept = loadLedger().filter(x=>x.id!==id);
        saveLedger(kept);
        toast('å·²åˆªé™¤');
        renderPay();
      });
    });
  }

  ['input','change'].forEach(evt=>{
    hkdEl.addEventListener(evt, calcPreview);
    rateEl.addEventListener(evt, calcPreview);
    pctOEl.addEventListener(evt, calcPreview);
    pctMEl.addEventListener(evt, calcPreview);
  });

  $('#pay_rate_link').addEventListener('click', ()=> window.open(RATE_URL,'_blank'));

  $('#pay_clear').addEventListener('click', ()=>{
    hkdEl.value='';
    rateEl.value='';
    pctOEl.value='85';
    pctMEl.value='15';
    $('#pay_note').value='';
    calcPreview();
    toast('å·²æ¸…ç©º');
  });

  $('#pay_copy_other').addEventListener('click', async ()=>{
    const res = calcPreview();
    if (!res) return toast('å…ˆè¼¸å…¥è³‡æ–™');
    await copyText(`çµ¦ä½ äººæ°‘å¹£ï¼š${fmt(res.other)}ï¼ˆç¸½é¡ ${fmt(res.total)} Ã— ${res.pctO}%ï¼‰`);
  });

  $('#pay_copy_all').addEventListener('click', async ()=>{
    const res = calcPreview();
    if (!res) return toast('å…ˆè¼¸å…¥è³‡æ–™');
    const note = ($('#pay_note').value || '').trim();
    const text =
`å…Œæ›æ˜ç´°ï¼ˆHKDâ†’RMBï¼‰
HKDï¼š${fmt(res.hkd)}
åŒ¯ç‡ï¼š1 HKD = ${fmt(res.rate,4)} RMB
RMB ç¸½é¡ï¼š${fmt(res.total)}
çµ¦å°æ–¹ï¼ˆ${res.pctO}%ï¼‰ï¼š${fmt(res.other)}
æˆ‘ç•™ï¼ˆ${res.pctM}%ï¼‰ï¼š${fmt(res.me)}
æ™‚é–“ï¼š${nowStr()}
åŒ¯ç‡ä¾†æºï¼š${RATE_URL}${note ? `\nå‚™è¨»ï¼š${note}` : ''}`;
    await copyText(text);
  });

  $('#pay_save').addEventListener('click', ()=>{
    const res = calcPreview();
    if (!res) return toast('å…ˆè¼¸å…¥ HKD èˆ‡åŒ¯ç‡');

    const note = ($('#pay_note').value || '').trim();
    const item = {
      id: uid(),
      type: 'exchange',
      ts: nowISO(),
      month: currentMonth,
      hkd: res.hkd,
      rate: res.rate,
      pctOther: res.pctO,
      pctMe: res.pctM,
      totalRmb: res.total,
      otherRmb: res.other,
      meRmb: res.me,
      note,
      rateUrl: RATE_URL
    };

    const all2 = loadLedger();
    all2.push(item);
    all2.sort((a,b)=>(a.ts||'').localeCompare(b.ts||''));
    saveLedger(all2);

    toast('å·²å­˜å…¥çµå¸³ï¼ˆæˆ‘ç•™å·²é€²é¤˜é¡ï¼‰');

    const b = loadBatch();
    if ((b.items||[]).length){
      const ok = confirm('è¦æ¸…ç©ºã€Œæ‰¹æ¬¡åŠ ç¸½æ¸…å–®ã€å—ï¼Ÿ\nï¼ˆé¿å…ä¸‹æ¬¡é‡è¤‡çµå¸³ï¼‰');
      if (ok) saveBatch({ items: [] , sumHKD: 0 });
    }

    renderPay();
  });

  $('#m_prev').addEventListener('click', ()=>{ currentMonth = shiftMonth(currentMonth,-1); renderPay(); });
  $('#m_next').addEventListener('click', ()=>{ currentMonth = shiftMonth(currentMonth,+1); renderPay(); });

  calcPreview();
  renderMonthBlock();
}

/* ===========================
   Ledger: æŒ‰æœˆæª¢ç´¢ + é¤˜é¡å­˜å…¥/é ˜å‡º + RMBâ†’TWD è¨˜éŒ„ + å‚™ä»½
=========================== */
function renderLedger(){
  const all = loadLedger();
  const bal = calcBalance(all);
  const sum = monthSummary(all, currentMonth);

  panelLeft.innerHTML = `
    <div class="hd">
      <div>
        <div class="t">è¨˜å¸³èˆ‡é¤˜é¡ï¼ˆæŒ‰æœˆæª¢ç´¢ï¼‰</div>
        <div class="s">çµå¸³ï¼ˆæˆ‘ç•™ï¼‰è‡ªå‹•é€²é¤˜é¡ï¼›å¯æ‰‹å‹•å­˜å…¥/é ˜å‡ºï¼›æ–°å¢ï¼šRMBâ†’TWD æ›åŒ¯è¨˜éŒ„ï¼ˆæœƒæ‰£é¤˜é¡ï¼‰ï¼›å¯åŒ¯å‡º/åŒ¯å…¥å‚™ä»½ã€‚</div>
      </div>
      <div class="tag in">ç›®å‰é¤˜é¡ï¼š<span class="mono">${fmt(bal)}</span> RMB</div>
    </div>
    <div class="bd">
      <div class="toolbar">
        <div class="left">
          <div style="font-weight:900">é¸æ“‡æœˆä»½</div>
          <input id="ledger_month" type="month" value="${currentMonth}" style="max-width:180px" />
          <button class="smallbtn" id="ledger_prev">â—€</button>
          <button class="smallbtn" id="ledger_next">â–¶</button>
        </div>
        <div class="right">
          <button class="smallbtn" id="export_btn">åŒ¯å‡ºå‚™ä»½</button>
          <button class="smallbtn" id="import_btn">åŒ¯å…¥å‚™ä»½</button>
          <button class="smallbtn" id="clear_month_btn">æ¸…ç©ºæœ¬æœˆ</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="kpi">
        <div class="k">
          <div class="lbl">æœ¬æœˆ HKD åˆè¨ˆï¼ˆçµå¸³ï¼‰</div>
          <div class="val mono">${fmt(sum.sumHKD)}</div>
          <div class="sub">HKDâ†’RMB</div>
        </div>
        <div class="k">
          <div class="lbl">æœ¬æœˆ æˆ‘ç•™ï¼ˆè‡ªå‹•é€²é¤˜é¡ï¼‰</div>
          <div class="val mono">${fmt(sum.sumMe)}</div>
          <div class="sub">HKDâ†’RMB</div>
        </div>
        <div class="k">
          <div class="lbl">æœ¬æœˆ RMBâ†’TWDï¼ˆç”¨ RMBï¼‰</div>
          <div class="val mono">${fmt(sum.sumRmbToTwdRmb)}</div>
          <div class="sub">æœƒæ‰£é¤˜é¡</div>
        </div>
        <div class="k">
          <div class="lbl">æœ¬æœˆ RMBâ†’TWDï¼ˆæ›å¾— TWDï¼‰</div>
          <div class="val mono">${fmt(sum.sumRmbToTwdTwd)}</div>
          <div class="sub">è¨˜éŒ„ç”¨é€”</div>
        </div>
      </div>

      <div class="divider"></div>

      <div style="font-weight:900;margin-bottom:6px">é¤˜é¡èª¿æ•´ï¼ˆRMB å­˜å…¥/é ˜å‡ºï¼‰</div>
      <div class="row">
        <div>
          <label for="adj_type">é¡å‹</label>
          <select id="adj_type">
            <option value="balance_in">å­˜å…¥ï¼ˆ+ï¼‰</option>
            <option value="balance_out">é ˜å‡ºï¼ˆ-ï¼‰</option>
          </select>
        </div>
        <div>
          <label for="adj_amount">é‡‘é¡ï¼ˆRMBï¼‰</label>
          <input id="adj_amount" inputmode="decimal" placeholder="ä¾‹å¦‚ï¼š200" />
        </div>
      </div>
      <div style="margin-top:10px">
        <label for="adj_note">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
        <input id="adj_note" placeholder="ä¾‹å¦‚ï¼šç¾é‡‘å­˜å…¥/é ˜å‡º/è½‰å¸³" />
      </div>

      <div class="actions">
        <button class="btn-primary" id="adj_save">å­˜å…¥è¨˜éŒ„</button>
        <button class="btn-ghost" id="copy_balance">è¤‡è£½ç›®å‰é¤˜é¡</button>
      </div>

      <div class="divider"></div>

      <div style="font-weight:900;margin-bottom:6px">RMB â†’ TWD æ›åŒ¯è¨˜éŒ„ï¼ˆæœƒæ‰£é¤˜é¡ï¼‰</div>
      <div class="row">
        <div>
          <label for="rt_rmb">ä½¿ç”¨äººæ°‘å¹£ï¼ˆRMBï¼‰</label>
          <input id="rt_rmb" inputmode="decimal" placeholder="ä¾‹å¦‚ï¼š1000" />
        </div>
        <div>
          <label for="rt_rate">åŒ¯ç‡ï¼ˆ1 RMB = ? TWDï¼‰</label>
          <input id="rt_rate" inputmode="decimal" placeholder="ä¾‹å¦‚ï¼š4.35" />
        </div>
      </div>
      <div style="margin-top:10px">
        <label for="rt_note">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
        <input id="rt_note" placeholder="ä¾‹å¦‚ï¼šæ›ç¾é‡‘/è½‰å¸³ç”¨é€”/èª°çš„æ¬¾" />
      </div>

      <div class="actions">
        <button class="btn-warn" id="rt_preview">å…ˆç®—ä¸€ä¸‹</button>
        <button class="btn-primary" id="rt_save">å­˜å…¥ RMBâ†’TWD è¨˜éŒ„</button>
        <button class="btn-ghost" id="rt_copy">è¤‡è£½æœ¬æ¬¡æ˜ç´°</button>
      </div>

      <div class="note" id="rt_note_box">
        âœ… é€™ç­†æœƒã€Œæ‰£æ‰ä½ çš„ RMB é¤˜é¡ã€ã€‚<br/>
        âœ… TWD æ˜¯è¨˜éŒ„ç”¨ï¼ˆæ–¹ä¾¿ä½ å›é ­å°å¸³ï¼‰ï¼ŒåŒ¯ç‡ä½ æ‰‹å‹•è¼¸å…¥å³å¯ã€‚
      </div>
    </div>
  `;

  panelRight.innerHTML = `
    <div class="hd">
      <div>
        <div class="t">æœ¬æœˆæ˜ç´°</div>
        <div class="s">å¯åˆªé™¤å–®ç­†ï¼ˆæœƒè‡ªå‹•é‡ç®—é¤˜é¡ï¼‰ã€‚</div>
      </div>
      <div class="tag">æœˆä»½ï¼š<span class="mono">${currentMonth}</span></div>
    </div>
    <div class="bd">
      <ul class="list" id="ledger_list"></ul>
    </div>
  `;

  const listEl = $('#ledger_list');

  function renderList(){
    const arr = loadLedger().filter(x=>x.month===currentMonth)
      .slice().sort((a,b)=>(b.ts||'').localeCompare(a.ts||''));

    if (!arr.length){
      listEl.innerHTML = `<li class="item muted">æœ¬æœˆå°šç„¡ç´€éŒ„</li>`;
      return;
    }
    listEl.innerHTML = '';
    for (const it of arr){
      const li = document.createElement('li');
      li.className = 'item';

      if (it.type === 'exchange'){
        li.innerHTML = `
          <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start">
            <div>
              <div class="mono"><span class="tag in">çµå¸³</span> HKD ${fmt(it.hkd)} Ã— rate ${fmt(it.rate,4)} = RMB ${fmt(it.totalRmb)}</div>
              <div class="mono muted" style="margin-top:4px">å°æ–¹ ${fmt(it.otherRmb)}ï¼ˆ${it.pctOther}%ï¼‰ï½œæˆ‘ç•™ ${fmt(it.meRmb)}ï¼ˆ${it.pctMe}%ï¼‰</div>
              ${it.note ? `<div class="muted" style="margin-top:4px">å‚™è¨»ï¼š${escapeHtml(it.note)}</div>` : ``}
              <div class="muted" style="margin-top:4px">${fmtTime(it.ts)} ãƒ» <a href="${it.rateUrl||RATE_URL}" target="_blank" rel="noreferrer">ğŸ”— åŒ¯ç‡ä¾†æº</a></div>
            </div>
            <div style="white-space:nowrap">
              <button class="smallbtn" data-del="${it.id}">åˆªé™¤</button>
            </div>
          </div>
        `;
      } else if (it.type === 'balance_in') {
        li.innerHTML = `
          <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start">
            <div>
              <div class="mono"><span class="tag in">å­˜å…¥</span> RMB +${fmt(it.amountRmb)}</div>
              ${it.note ? `<div class="muted" style="margin-top:4px">å‚™è¨»ï¼š${escapeHtml(it.note)}</div>` : ``}
              <div class="muted" style="margin-top:4px">${fmtTime(it.ts)}</div>
            </div>
            <div style="white-space:nowrap">
              <button class="smallbtn" data-del="${it.id}">åˆªé™¤</button>
            </div>
          </div>
        `;
      } else if (it.type === 'balance_out') {
        li.innerHTML = `
          <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start">
            <div>
              <div class="mono"><span class="tag out">é ˜å‡º</span> RMB -${fmt(it.amountRmb)}</div>
              ${it.note ? `<div class="muted" style="margin-top:4px">å‚™è¨»ï¼š${escapeHtml(it.note)}</div>` : ``}
              <div class="muted" style="margin-top:4px">${fmtTime(it.ts)}</div>
            </div>
            <div style="white-space:nowrap">
              <button class="smallbtn" data-del="${it.id}">åˆªé™¤</button>
            </div>
          </div>
        `;
      } else {
        // rmb_to_twd
        li.innerHTML = `
          <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start">
            <div>
              <div class="mono"><span class="tag fx">RMBâ†’TWD</span> ç”¨ RMB ${fmt(it.rmb)} Ã— rate ${fmt(it.rate,4)} = TWD ${fmt(it.twd)}</div>
              ${it.note ? `<div class="muted" style="margin-top:4px">å‚™è¨»ï¼š${escapeHtml(it.note)}</div>` : ``}
              <div class="muted" style="margin-top:4px">${fmtTime(it.ts)}</div>
            </div>
            <div style="white-space:nowrap">
              <button class="smallbtn" data-del="${it.id}">åˆªé™¤</button>
            </div>
          </div>
        `;
      }

      listEl.appendChild(li);
    }

    listEl.querySelectorAll('[data-del]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.getAttribute('data-del');
        if (!id) return;
        const kept = loadLedger().filter(x=>x.id!==id);
        saveLedger(kept);
        toast('å·²åˆªé™¤');
        renderLedger();
      });
    });
  }

  // month controls
  $('#ledger_month').addEventListener('change', ()=>{
    const v = $('#ledger_month').value;
    if (v) currentMonth = v;
    renderLedger();
  });
  $('#ledger_prev').addEventListener('click', ()=>{ currentMonth = shiftMonth(currentMonth,-1); renderLedger(); });
  $('#ledger_next').addEventListener('click', ()=>{ currentMonth = shiftMonth(currentMonth,+1); renderLedger(); });

  // balance adjust save
  $('#adj_save').addEventListener('click', ()=>{
    const type = $('#adj_type').value;
    const amt = toNum($('#adj_amount').value);
    if (!Number.isFinite(amt) || amt <= 0) return toast('è«‹è¼¸å…¥é‡‘é¡');
    const note = ($('#adj_note').value || '').trim();

    const item = {
      id: uid(),
      type,
      ts: nowISO(),
      month: currentMonth,
      amountRmb: amt,
      note
    };

    const all2 = loadLedger();
    all2.push(item);
    all2.sort((a,b)=>(a.ts||'').localeCompare(b.ts||''));
    saveLedger(all2);

    $('#adj_amount').value = '';
    $('#adj_note').value = '';
    toast(type === 'balance_in' ? 'å·²å­˜å…¥ï¼ˆé¤˜é¡å¢åŠ ï¼‰' : 'å·²é ˜å‡ºï¼ˆé¤˜é¡æ‰£é™¤ï¼‰');
    renderLedger();
  });

  $('#copy_balance').addEventListener('click', async ()=>{
    const all2 = loadLedger();
    const bal2 = calcBalance(all2);
    await copyText(`ç›®å‰é¤˜é¡ï¼š${fmt(bal2)} RMB`);
  });

  // RMB->TWD preview/save/copy
  function calcRmbToTwd(){
    const rmb = toNum($('#rt_rmb').value);
    const rate = toNum($('#rt_rate').value); // 1 RMB = ? TWD
    if (!Number.isFinite(rmb) || rmb <= 0) return null;
    if (!Number.isFinite(rate) || rate <= 0) return null;
    const twd = rmb * rate;
    return { rmb, rate, twd };
  }

  $('#rt_preview').addEventListener('click', ()=>{
    const res = calcRmbToTwd();
    if (!res) return toast('è«‹è¼¸å…¥ RMB èˆ‡åŒ¯ç‡');
    $('#rt_note_box').innerHTML =
      `æœ¬æ¬¡é ä¼°ï¼šç”¨ <b class="mono">RMB ${fmt(res.rmb)}</b> Ã— rate <b class="mono">${fmt(res.rate,4)}</b> = <b class="mono">TWD ${fmt(res.twd)}</b><br>` +
      `âœ… é€™ç­†å­˜å…¥å¾Œæœƒæ‰£ä½ çš„ RMB é¤˜é¡ã€‚`;
    toast('å·²è¨ˆç®—');
  });

  $('#rt_copy').addEventListener('click', async ()=>{
    const res = calcRmbToTwd();
    if (!res) return toast('è«‹è¼¸å…¥ RMB èˆ‡åŒ¯ç‡');
    const note = ($('#rt_note').value || '').trim();
    const text =
`æ›åŒ¯è¨˜éŒ„ï¼ˆRMBâ†’TWDï¼‰
ä½¿ç”¨ RMBï¼š${fmt(res.rmb)}
åŒ¯ç‡ï¼š1 RMB = ${fmt(res.rate,4)} TWD
æ›å¾— TWDï¼š${fmt(res.twd)}
æ™‚é–“ï¼š${nowStr()}${note ? `\nå‚™è¨»ï¼š${note}` : ''}`;
    await copyText(text);
  });

  $('#rt_save').addEventListener('click', ()=>{
    const res = calcRmbToTwd();
    if (!res) return toast('è«‹è¼¸å…¥ RMB èˆ‡åŒ¯ç‡');
    const note = ($('#rt_note').value || '').trim();

    const item = {
      id: uid(),
      type: 'rmb_to_twd',
      ts: nowISO(),
      month: currentMonth,
      rmb: res.rmb,
      rate: res.rate,
      twd: res.twd,
      note
    };

    const all2 = loadLedger();
    all2.push(item);
    all2.sort((a,b)=>(a.ts||'').localeCompare(b.ts||''));
    saveLedger(all2);

    $('#rt_rmb').value = '';
    $('#rt_rate').value = '';
    $('#rt_note').value = '';
    $('#rt_note_box').innerHTML =
      `âœ… é€™ç­†æœƒã€Œæ‰£æ‰ä½ çš„ RMB é¤˜é¡ã€ã€‚<br/>âœ… TWD æ˜¯è¨˜éŒ„ç”¨ï¼ˆæ–¹ä¾¿ä½ å›é ­å°å¸³ï¼‰ï¼ŒåŒ¯ç‡ä½ æ‰‹å‹•è¼¸å…¥å³å¯ã€‚`;

    toast('å·²å­˜å…¥ RMBâ†’TWD è¨˜éŒ„ï¼ˆå·²æ‰£é¤˜é¡ï¼‰');
    renderLedger();
  });

  // export/import backup (JSON -> clipboard)
  $('#export_btn').addEventListener('click', async ()=>{
    const payload = {
      app: 'change-pay-hr',
      version: 21,
      exportedAt: nowISO(),
      ledger: loadLedger(),
      batch: loadBatch()
    };
    await copyText(JSON.stringify(payload));
    toast('å·²åŒ¯å‡ºåˆ°å‰ªè²¼ç°¿ï¼ˆJSONï¼‰');
  });

  $('#import_btn').addEventListener('click', async ()=>{
    try{
      const text = await navigator.clipboard.readText();
      if (!text) return toast('å‰ªè²¼ç°¿æ²’æœ‰å…§å®¹');
      const obj = JSON.parse(text);
      if (!obj || typeof obj !== 'object') return toast('æ ¼å¼ä¸å°');
      if (!Array.isArray(obj.ledger)) return toast('æ‰¾ä¸åˆ° ledger');
      saveLedger(obj.ledger);
      if (obj.batch && typeof obj.batch === 'object') saveBatch(obj.batch);
      toast('å·²åŒ¯å…¥å®Œæˆ');
      renderLedger();
    }catch{
      toast('åŒ¯å…¥å¤±æ•—ï¼ˆè«‹ç¢ºèªå‰ªè²¼ç°¿æ˜¯ JSONï¼‰');
    }
  });

  $('#clear_month_btn').addEventListener('click', ()=>{
    const ok = confirm(`ç¢ºå®šè¦æ¸…ç©º ${currentMonth} çš„å…¨éƒ¨ç´€éŒ„å—ï¼Ÿ\nï¼ˆåªæœƒåˆªé™¤è©²æœˆï¼Œä¸å½±éŸ¿å…¶ä»–æœˆä»½ï¼‰`);
    if (!ok) return;
    const kept = loadLedger().filter(x=>x.month!==currentMonth);
    saveLedger(kept);
    toast('å·²æ¸…ç©ºæœ¬æœˆ');
    renderLedger();
  });

  renderList();
}

/* ===========================
   Network pill
=========================== */
function updateNetPill(){
  const el = $('#netStatus');
  const on = navigator.onLine;
  el.textContent = on ? 'ç›®å‰ç‹€æ…‹ï¼šåœ¨ç·š' : 'ç›®å‰ç‹€æ…‹ï¼šé›¢ç·šï¼ˆä»å¯ç”¨ï¼‰';
}
window.addEventListener('online', updateNetPill);
window.addEventListener('offline', updateNetPill);

/* ===========================
   Boot
=========================== */
render();
</script>
</body>
</html>
